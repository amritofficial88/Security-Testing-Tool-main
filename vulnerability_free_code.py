import openai
import streamlit as st


class VulnerabilityFreeCode:
    def __init__(self, fixed_code, pdf_report, report_service):
        self.fixed_code = fixed_code
        self.pdf_report = pdf_report
        self.report_service = report_service

    def display(self):
        """Displays the fixed code and the download buttons for code and report."""
        st.subheader("Vulnerability-Free Code:")

        st.code(self.fixed_code, language='python')
        st.download_button(
            label="Download Fixed Code",
            data=self.fixed_code,
            file_name="fixed_code.py",
            mime="text/plain"
        )

        if st.button("Generate Report"):
            pdf_report = self.report_service.generate_pdf_report(
                st.session_state['last_user_code'],
                st.session_state['vulnerability_report']
            )

            st.download_button(
                label="Download PDF report",
                data=pdf_report,
                file_name="vulnerability_report.pdf",
                mime="application/pdf"
            )


def rewrite_code_with_openai(input_code, selected_issues):
    """
    Uses OpenAI to rewrite the input code to remove only the specified vulnerabilities.
    Ensures that the output is code-only, with no extra explanations or comments.
    """
    # Format the selected issues as a numbered list for clarity
    formatted_issues = "\n".join(
        [f"{i+1}. {issue}" for i, issue in enumerate(selected_issues.split('\n')) if issue.strip()])

    prompt = f"""
    I have the following Python code, and I've run a static analysis tool that provided a vulnerability report.
    Please rewrite the code to be secure and resolve all of the specified vulnerabilities below.
    Do not add any explanations, descriptions, or comments in English. Only return the modified Python code.

    --- Original Code ---
    {input_code}

    --- Selected Vulnerabilities to Resolve ---
    {formatted_issues}

    Rewrite the code securely, addressing every one of the selected vulnerabilities listed above. Do not add any English explanations or comments.
    """
    try:
        response = openai.ChatCompletion.create(
            model="gpt-4",
            messages=[
                {"role": "system",
                    "content": "You are a security expert and a Python code reviewer."},
                {"role": "user", "content": prompt}
            ],
            max_tokens=2000,
            temperature=0.5
        )

        rewritten_code = response['choices'][0]['message']['content'].strip()
        return rewritten_code
    except Exception as e:
        return f"Error occurred while calling OpenAI API: {str(e)}"
